var oldest_timestamp=9999999999;var lastest_timestamp=0;var olhc_list=[];var graph_type_list=[60*1,60*5,60*15,60*60,60*60*24,60*60*24*7];var graph_type=graph_type_list[2];function change_graph_type(a,b){oldest_timestamp=9999999999;lastest_timestamp=0;graph_type=graph_type_list[a];olhc_list=[];$("a#graph_type").attr("class","disable");$(b).attr("class","enable");getOLHC(0,function(){init()})}getOLHC(0,function(){set_size($("div.container").width(),$(window).height()/3);init();d3.select(window).on("resize",function(){set_size($("div.container").width(),$(window).height()/3);init()})});function add_missing_olhc(d,c){var a=d.t+graph_type;var e=[];if(c.t!=a){for(var b=a;b<c.t;b=b+graph_type){var f={t:b,o:d.c,l:d.c,h:d.c,c:d.c,v:0};e.push(f)}}return e}function add_sma_list(c){var b=[];for(var a=0;a<c.length;a++){b.push(c[a].c);c[a].sma10=0;c[a].sma50=0;c[a].sma100=0;if(a>10){c[a].sma10=_.reduce(_.last(b,10),function(e,f){return e+f},0)/10}if(a>50){c[a].sma50=_.reduce(_.last(b,50),function(e,f){return e+f},0)/50}if(a>100){c[a].sma100=_.reduce(_.last(b,100),function(e,f){return e+f},0)/100}}return c}function add_to_last(b,c){var a=Math.floor(b.t/graph_type)*graph_type;if(c!=null&&c.t==a){var e=b.p;c.c=e;c.h=(c.h<e?e:c.h);c.l=(c.l>e?e:c.l);c.v+=b.v;return c}else{var d={t:a,o:b.p,l:b.p,h:b.p,c:b.p,v:b.v};if(c==null){c=d}add_missing_olhc(c,d);olhc_list.push(d);return d}}function add_to_olhc(b){var a=Math.floor(b.t/graph_type)*graph_type;var c=_.last(olhc_list);add_to_last(b,c);add_sma_list(olhc_list);return(a==c.t)}function updateOldestTimestamp(a){if(oldest_timestamp==null||oldest_timestamp>a){oldest_timestamp=a}}function updateLastestTimestamp(a){if(lastest_timestamp==null||lastest_timestamp<a){lastest_timestamp=a}}function getOldOLHC(a,b){b()}function getOLHC(a,b){$.ajax({type:"GET",url:"http://www.btckorea.org:8888/chart",success:function(c){var d=_.last(olhc_list);_.each(c,function(e){d=add_to_last({t:parseInt(e.time),p:parseFloat(e.price),v:parseFloat(e.last_qty)},d)});add_sma_list(olhc_list);b()},error:function(e,c,d){console.log("code:"+e.status+"\nmessage:"+e.responseText+"\nerror:"+d)}})};