<html>
  <head>
    <title>Hello, Korea!</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">    
    <script type="text/javascript" src="underscore.js"></script>
    <script type="text/javascript" src="moment-with-langs.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/numeral.js/1.4.5/numeral.min.js"></script>
    <script type="text/javascript" src="http://j96.me:8888/faye/client.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

    <script type="text/javascript">
      var max_price = 0;
      var min_price = 99999999;

      var bitstamp_max_price = 0;
      var bitstamp_min_price = 99999999;
      $(function() {
        $.getJSON('http://j96.me:8888',function(json) {


          var history = json.history
          history = _.sortBy(history, function(item) { return item.time });

          for(i in history)
            addRow(history[i], false);  

          $('#min_max tbody tr:last').append('<td id="min">' + json['min'] + '</td><td id="max">' + json['max'] + '</td>');

        });

        var client = new Faye.Client('http://j96.me:8888/faye');
        client.subscribe('/trade', function(json){ addRow(json.trade, true); });
        client.subscribe('/min', function(json){ $('#min').text(json.price); });
        client.subscribe('/max', function(json){ $('#max').text(json.price); });
      });

      function addRow(json, can_flash) {
        $('#history tbody').prepend(makeRow(json));  
        if(can_flash)
          flash($('#history tbody tr:first'), 'green');
      }

      function makeRow(json) {
        var is_max = false;
        var is_min = false;
        var is_large_amount = false;
        
        var is_bitstamp_max = false;
        var is_bitstamp_min = false;

        if(max_price < parseInt(json.price))
        {
          is_max = true;
          max_price = parseInt(json.price);
        }

        if(min_price > parseInt(json.price))
        {
          is_min = true;
          min_price = parseInt(json.price);
        }

        if(parseInt(json.last_qty) >= 10)
          is_large_amount = true;
        
        if(bitstamp_max_price < parseFloat(json.bitstamp))
        {
          is_bitstamp_max = true;
          bitstamp_max_price = parseFloat(json.bitstamp);
        }
        
        if(bitstamp_min_price > parseFloat(json.bitstamp))
        {
          is_bitstamp_min = true;
          bitstamp_min_price = parseFloat(json.bitstamp);
        }

        return '<tr id="' + json.site + '"><td id="time">' + moment.unix(json.time).format('HH:mm') + '</td>' +
          '<td id="price" class="' + (is_max?'max':(is_min?'min':'')) + '">' + numeral(json.price).format('0,0') + ' (' + json.site.slice(0,1).toUpperCase() + ')' + (is_max?'↑':(is_min?'↓':'')) + '</td>' +
          '<td id="bitstamp" class="' + (is_bitstamp_max?'max':(is_bitstamp_min?'min':'')) + '">' + depth_style(json.bitstamp, 2) + ' ' + (is_bitstamp_max?'↑':(is_bitstamp_min?'↓':'')) + '</td>' +
          '<td id="volume" class="' + (is_large_amount?'large_amount':'') + '">' + depth_style(json.last_qty, 2) + '</td>';
      }
      function log(str) {
        //$('#log').val(str + '\n' + $('#log').val());
      };

      zero = ["", "0", "00", "000", "0000"];
      function depth_style(num, digit) {
        var d = parseFloat(num).toFixed(digit);
        for (var n = d.length, i = 1; i < digit;)
          if (d.charAt(n - i) == "0")
            i++;
          else {
            if (i == 1)
              return d;
            break
          }
        return d.slice(0, n - i + 1) + '<span class="zero">' + zero[i - 1] + "</span>"
      }

      function flash(element, type) {
        if (type == '')
          return;
        $(element).addClass(type);
        setTimeout(function () {
          $(element).removeClass(type);
        }, 1000);

      };
    </script>
    <style>
      body {
        font-family: Tahoma, Geneva, sans-serif;
        
        background-color: black;
        color: white;
        margin: 0px;
        padding: 0px;
      }
      table {
        margin: 0px;
        padding: 0px;
        width: 100%;
        border: 0px;
        border-collapse:collapse;
        font-size: 15px;
      }

      #min_max tr td {
        border: 1px solid black;
        background-color: gray;
      }

      table td {
        text-align: center;
      }
      table #time {
        width: 20%;
      }
      table #price {
        width: 40%;
        text-align: left;
        padding-left: 10%;
      }
      table #bitstamp {
        width: 20%;
        text-align: left;
        padding-left: 3%;
      }
      table #volume {
        padding-right: 4%;
        text-align: right;
      }

      .zero {
        color: gray;
      }
      .max {
        color: #72bf44;

      }
      .min {
        color: red;
      }
      .large_amount {
        color: red;
        font-weight: bold;
      }

      .green {
        background-color: #72bf44;
      }
    </style>
  </head>
  <body>
    <table id="min_max">
      <thead>
        <tr>
          <td>최저가</td>
          <td>최고가</td>
        </tr>
      </thead>
      <tbody>
        <tr></tr>
      </tbody>
    </table>

    <table id="history">
      <thead>
        <tr>
          <td>Time</td>
          <td id="price">Last Price</td>
          <td id="bitstamp">Bitstamp</td>
          <td id="volume">Qty</td>
        </tr>
      </thead>
      <tbody>
        <tr id="list">
        </tr>
      </tbody>

    </table>
    <!--<textarea id="log" style="width:700;height:300;"></textarea>-->
  </body>
</html>